Program.cs Structure â€“ .NET Core API

This document defines the correct logical order for configuring Program.cs in a production-ready .NET Core Web API.

ğŸ— BUILDER SECTION (Service Configuration)

All service registrations must happen before builder.Build().

âœ… Correct Logical Order â€“ Builder
1ï¸âƒ£ Logging

Configure structured logging (Serilog or other provider) before anything else.

Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Debug()
    .WriteTo.Console()
    .CreateLogger();

builder.Host.UseSerilog();

2ï¸âƒ£ Database

Register DbContext based on environment.

if (builder.Environment.IsDevelopment())
{
    builder.Services.AddDbContext<AuthDbContext>(options =>
        options.UseInMemoryDatabase("AuthDb"));
}
else
{
    builder.Services.AddDbContext<AuthDbContext>(options =>
        options.UseSqlServer(
            builder.Configuration.GetConnectionString("DefaultConnection")));
}

3ï¸âƒ£ JWT Configuration

Read and validate JWT settings from configuration.

var jwtSettings = builder.Configuration
    .GetSection("Jwt")
    .Get<JwtSettings>()
    ?? throw new Exception("JWT configuration missing");

4ï¸âƒ£ Authentication / Authorization
builder.Services
    .AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = jwtSettings.Issuer,
            ValidAudience = jwtSettings.Audience,
            IssuerSigningKey =
                new SymmetricSecurityKey(
                    Encoding.UTF8.GetBytes(jwtSettings.Secret))
        };
    });

builder.Services.AddAuthorization();

5ï¸âƒ£ Controllers
builder.Services
    .AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.Converters.Add(
            new JsonStringEnumConverter());
    });

builder.Services.AddEndpointsApiExplorer();

6ï¸âƒ£ CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
        policy.AllowAnyOrigin()
              .AllowAnyHeader()
              .AllowAnyMethod());
});

7ï¸âƒ£ Swagger
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "AuthService API",
        Version = "v1"
    });
});

8ï¸âƒ£ Validation (FluentValidation)
builder.Services.AddFluentValidationAutoValidation();
builder.Services.AddValidatorsFromAssemblyContaining<RegisterDtoValidator>();

9ï¸âƒ£ Application Services
builder.Services.AddScoped<IAuthService, AuthServiceImpl>();
builder.Services.AddScoped<IPasswordHasher, PasswordHasher>();
builder.Services.AddScoped<IJwtService, JwtService>();

ğŸ”Ÿ Kestrel
builder.WebHost.ConfigureKestrel(options =>
{
    options.ListenAnyIP(5081);
});

ğŸš€ APP SECTION (Middleware Pipeline)

Everything below runs after:

var app = builder.Build();

âœ… Correct Logical Order â€“ App
ğŸŸ¢ 1ï¸âƒ£ Database Reset First (Optional â€“ Dev Only)

Must happen before middleware pipeline runs.

if (app.Environment.IsDevelopment())
{
    await DbResetService.ClearUsersAsync(app.Services);
}

ğŸŸ¢ 2ï¸âƒ£ Global Exception Handling (Early)

Must wrap the entire pipeline.

app.UseMiddleware<GlobalExceptionHandler>();

ğŸŸ¢ 3ï¸âƒ£ Swagger (Development Only)
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

ğŸŸ¢ 4ï¸âƒ£ Routing (Before Auth)
app.UseRouting();

ğŸŸ¢ 5ï¸âƒ£ CORS
app.UseCors("AllowAll");

ğŸŸ¢ 6ï¸âƒ£ Authentication
app.UseAuthentication();

ğŸŸ¢ 7ï¸âƒ£ Authorization
app.UseAuthorization();

ğŸŸ¢ 8ï¸âƒ£ Map Endpoints (Before Run)
app.MapControllers();

ğŸŸ¢ 9ï¸âƒ£ app.Run() â€“ ALWAYS LAST
app.Run();


Anything after app.Run() will never execute.

ğŸ§  Visual Summary
Builder Order

Logging

Database

JWT Config

Authentication / Authorization

Controllers

CORS

Swagger

Validation

Services

Kestrel

App Order

Database Reset

Exception Handling

Swagger

Routing

CORS

Authentication

Authorization

Map Endpoints

Run

ğŸ† Best Practice Rules

Never register services twice.

Keep builder clean and grouped.

Middleware order matters.

app.Run() is always last.

Exception middleware must be first in pipeline.

Routing must come before authentication.
