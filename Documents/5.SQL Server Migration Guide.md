
SQL Server Migration Guide
Step 1: Install SQL Server Packages


# AuthService
cd AuthService
dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Tools --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Design --version 8.0.0

# RouteService
cd ../RouteService
dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Tools --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Design --version 8.0.0

# PackageService
cd ../PackageService
dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Tools --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Design --version 8.0.0

Step 2: Update Connection Strings
AuthService/appsettings.json

{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=SmartDelivery_AuthDb;User Id=sa;Password=YourStrong@Password123;TrustServerCertificate=True;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Jwt": {
    "Secret": "SmartDeliverySystemSuperSecretKeyForJWTTokenGeneration2026!@#",
    "Issuer": "SmartDeliverySystem",
    "Audience": "SmartDeliveryUsers",
    "ExpirationHours": 8
  },
  "Urls": "http://localhost:5001"
}

RouteService/appsettings.json

{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=SmartDelivery_RouteDb;User Id=sa;Password=YourStrong@Password123;TrustServerCertificate=True;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Jwt": {
    "Secret": "SmartDeliverySystemSuperSecretKeyForJWTTokenGeneration2024!@#",
    "Issuer": "SmartDeliverySystem",
    "Audience": "SmartDeliveryUsers"
  },
  "Urls": "http://localhost:5002"
}


PackageService/appsettings.json

{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=SmartDelivery_PackageDb;User Id=sa;Password=YourStrong@Password123;TrustServerCertificate=True;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Jwt": {
    "Secret": "SmartDeliverySystemSuperSecretKeyForJWTTokenGeneration2024!@#",
    "Issuer": "SmartDeliverySystem",
    "Audience": "SmartDeliveryUsers"
  },
  "RouteService": {
    "BaseUrl": "http://localhost:5002"
  },
  "Urls": "http://localhost:5003"
}

Step 3: Update Program.cs for Each Service
AuthService/Program.cs (Update DbContext configuration)


// Replace this line:
// builder.Services.AddDbContext<AuthDbContext>(options =>
//     options.UseInMemoryDatabase("AuthDb"));

// With this:
builder.Services.AddDbContext<AuthDbContext>(options =>
    options.UseSqlServer(
        builder.Configuration.GetConnectionString("DefaultConnection"),
        sqlOptions => sqlOptions.EnableRetryOnFailure(
            maxRetryCount: 5,
            maxRetryDelay: TimeSpan.FromSeconds(30),
            errorNumbersToAdd: null
        )
    ));


RouteService/Program.cs (Update DbContext configuration)


// Replace:
// builder.Services.AddDbContext<RouteDbContext>(options =>
//     options.UseInMemoryDatabase("RouteDb"));

// With:
builder.Services.AddDbContext<RouteDbContext>(options =>
    options.UseSqlServer(
        builder.Configuration.GetConnectionString("DefaultConnection"),
        sqlOptions => sqlOptions.EnableRetryOnFailure(
            maxRetryCount: 5,
            maxRetryDelay: TimeSpan.FromSeconds(30),
            errorNumbersToAdd: null
        )
    ));


PackageService/Program.cs (Update DbContext configuration)

// Replace:
// builder.Services.AddDbContext<PackageDbContext>(options =>
//     options.UseInMemoryDatabase("PackageDb"));

// With:
builder.Services.AddDbContext<PackageDbContext>(options =>
    options.UseSqlServer(
        builder.Configuration.GetConnectionString("DefaultConnection"),
        sqlOptions => sqlOptions.EnableRetryOnFailure(
            maxRetryCount: 5,
            maxRetryDelay: TimeSpan.FromSeconds(30),
            errorNumbersToAdd: null
        )
    ));


Step 4: Create Initial Migrations
AuthService

cd AuthService

# Create initial migration
dotnet ef migrations add InitialCreate

# Review the generated migration in Migrations folder
# Then apply to database
dotnet ef database update

# Verify database was created
dotnet ef database update --verbose


RouteService

cd ../RouteService

# Create initial migration
dotnet ef migrations add InitialCreate

# Apply to database
dotnet ef database update

# Check migration status
dotnet ef migrations list


PackageService

cd ../PackageService

# Create initial migration
dotnet ef migrations add InitialCreate

# Apply to database
dotnet ef database update

# Verify
dotnet ef database update --verbose

Step 5: Verify Databases Created


-- Connect to SQL Server and run:
SELECT name FROM sys.databases 
WHERE name LIKE 'SmartDelivery_%';

-- Expected output:
-- SmartDelivery_AuthDb
-- SmartDelivery_RouteDb
-- SmartDelivery_PackageDb

Step 6: View Generated Schema

# AuthService - Check what was created
cd AuthService
dotnet ef dbcontext info

# RouteService
cd ../RouteService
dotnet ef dbcontext info

# PackageService
cd ../PackageService
dotnet ef dbcontext info

Common EF Core Commands
Create New Migration

# When you change models/entities
dotnet ef migrations add MigrationName

# Examples:
dotnet ef migrations add AddPhoneNumberToUser
dotnet ef migrations add AddStatusIndexToPackage

Apply Migrations

# Apply all pending migrations
dotnet ef database update

# Apply to specific migration
dotnet ef database update MigrationName

# Rollback to previous migration
dotnet ef database update PreviousMigrationName


Remove Last Migration

# Remove migration (before applying to database)
dotnet ef migrations remove

# Force remove (even if applied)
dotnet ef migrations remove --force

Generate SQL Script

# Generate SQL script for all migrations
dotnet ef migrations script

# Generate script for specific range
dotnet ef migrations script FromMigration ToMigration

# Generate script and save to file
dotnet ef migrations script > migration.sql

# Generate idempotent script (can run multiple times safely)
dotnet ef migrations script --idempotent

Database Commands

# Drop database
dotnet ef database drop

# Drop and recreate
dotnet ef database drop --force
dotnet ef database update

# View database info
dotnet ef dbcontext info

# List all migrations
dotnet ef migrations list

View Database Schema
After migrations, your SQL Server will have these tables:
AuthDb Tables:


USE SmartDelivery_AuthDb;
GO

-- Users table
SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'Users';

-- Sample query
SELECT Id, Username, Email, Role, IsActive, CreatedAt 
FROM Users;

RouteDb Tables:

USE SmartDelivery_RouteDb;
GO

-- Routes table
SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'Routes';

-- Sample query
SELECT Id, DriverId, VehicleId, StartLocation, EndLocation, 
       EstimatedDistanceKm, ScheduledDate 
FROM Routes;

PackageDb Tables:

USE SmartDelivery_PackageDb;
GO

-- Packages table
SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'Packages';

-- Sample query with status
SELECT Id, TrackingNumber, CustomerId, RouteId, 
       Status, WeightKg, CreatedAt 
FROM Packages;


Troubleshooting
If migrations fail:


# Clean and rebuild
dotnet clean
dotnet build

# Try again
dotnet ef migrations add InitialCreate --force
dotnet ef database update

If SQL Server connection fails:

# Test connection string
dotnet ef database update --verbose

# Check SQL Server is running
# Windows: services.msc -> SQL Server (MSSQLSERVER)
# Docker: docker ps


View detailed migration info:

dotnet ef migrations list --verbose
dotnet ef database update --verbose


SQL Server Docker (Optional)
If you don't have SQL Server installed:


# Run SQL Server in Docker
docker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=YourStrong@Password123" \
   -p 1433:1433 --name sqlserver \
   -d mcr.microsoft.com/mssql/server:2022-latest

# Wait 30 seconds for SQL Server to start
sleep 30

# Verify it's running
docker ps

# Connect and create databases
docker exec -it sqlserver /opt/mssql-tools/bin/sqlcmd \
   -S localhost -U sa -P "YourStrong@Password123" \
   -Q "CREATE DATABASE SmartDelivery_AuthDb; CREATE DATABASE SmartDelivery_RouteDb; CREATE DATABASE SmartDelivery_PackageDb;"


# Run SQL Server in Docker
docker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=YourStrong@Password123" \
   -p 1433:1433 --name sqlserver \
   -d mcr.microsoft.com/mssql/server:2022-latest

# Wait 30 seconds for SQL Server to start
sleep 30

# Verify it's running
docker ps

# Connect and create databases
docker exec -it sqlserver /opt/mssql-tools/bin/sqlcmd \
   -S localhost -U sa -P "YourStrong@Password123" \
   -Q "CREATE DATABASE SmartDelivery_AuthDb; CREATE DATABASE SmartDelivery_RouteDb; CREATE DATABASE SmartDelivery_PackageDb;"